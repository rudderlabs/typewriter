name: Draft new release

on:
  workflow_dispatch:

env:
  NODE_OPTIONS: '--no-warnings'

jobs:
  draft-new-release:
    name: Draft a new release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/hotfix/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install Dependencies
        env:
          HUSKY: 0
        run: npm run setup

      # In order to make a commit, we need to initialize a user.
      # You may choose to write something less generic here if you want, it doesn't matter functionality wise.
      - name: Initialize mandatory git config
        run: |
          git config user.name "GitHub actions"
          git config user.email noreply@github.com

      - name: Create 1.0.0 stable release branch
        id: create-release
        env:
          HUSKY: 0
        run: |
          source_branch_name=${GITHUB_REF##*/}
          release_type=release
          grep -q "hotfix/" <<< "${GITHUB_REF}" && release_type=hotfix-release
          git remote show origin
          git fetch origin master --depth=1
          git fetch --tags origin
          echo "Merging master into $source_branch_name"
          current_version=$(jq -r .version package.json)

          new_version=1.0.0

          branch_name="${release_type}/${new_version}"

          echo "Source branch for new release is $source_branch_name"
          echo "Current version is $current_version"
          echo "Release type is $release_type"
          echo "New version is $new_version"
          echo "New release branch name is $branch_name"
          git checkout -b "$branch_name"
          git push --set-upstream origin "$branch_name"

          echo "source_branch_name=$source_branch_name" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION_VALUE=$current_version" >> $GITHUB_ENV
          echo "NEW_VERSION_VALUE=$new_version" >> $GITHUB_ENV

      # # Calculate the next release version based on conventional semantic release
      # - name: Create release branch
      #   id: create-release
      #   env:
      #     HUSKY: 0
      #   run: |
      #     source_branch_name=${GITHUB_REF##*/}
      #     release_type=release
      #     grep -q "hotfix/" <<< "${GITHUB_REF}" && release_type=hotfix-release
      #     git remote show origin
      #     git fetch origin master --depth=1
      #     git fetch --tags origin
      #     echo "Merging master into $source_branch_name"
      #     current_version=$(jq -r .version package.json)

      #     npm version prerelease --no-git-tag-version --no-commit-hooks
      #     new_version=$(jq -r .version package.json)
      #     git reset --hard

      #     branch_name="${release_type}/${new_version}"

      #     echo "Source branch for new release is $source_branch_name"
      #     echo "Current version is $current_version"
      #     echo "Release type is $release_type"
      #     echo "New version is $new_version"
      #     echo "New release branch name is $branch_name"
      #     git checkout -b "$branch_name"
      #     git push --set-upstream origin "$branch_name"

      #     echo "source_branch_name=$source_branch_name" >> $GITHUB_OUTPUT
      #     echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
      #     echo "new_version=$new_version" >> $GITHUB_OUTPUT
      #     echo "CURRENT_VERSION_VALUE=$current_version" >> $GITHUB_ENV
      #     echo "NEW_VERSION_VALUE=$new_version" >> $GITHUB_ENV

      - name: Update changelog for 1.0.0 stable release
        id: finish-release
        env:
          HUSKY: 0
        run: |
          echo "Current version: $CURRENT_VERSION_VALUE"
          echo "New version: $NEW_VERSION_VALUE"
          git fetch --no-tags --prune --depth=100 origin master
          git tag -a "v1.0.0" -m "chore(release): v1.0.0"
          git push origin refs/tags/v1.0.0

      # - name: Update changelog & bump version
      #   id: finish-release
      #   env:
      #     HUSKY: 0
      #   run: |
      #     SUMMARY=$(((npx conventional-changelog -u) 2>&1) | sed "s/*/<br> */g" | sed "s/#/ /g" | tr -d '\n' || true)
      #     echo $SUMMARY
      #     echo "::set-output name=commit_summary::$SUMMARY"
      #     echo "Current version: $CURRENT_VERSION_VALUE"
      #     echo "New version: $NEW_VERSION_VALUE"
      #     git fetch --no-tags --prune --depth=100 origin master
      #     npm version prerelease --no-commit-hooks

      # - name: Push new version in release branch
      #   run: |
      #     git push --follow-tags

      - name: Create pull request into master
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ steps.create-release.outputs.branch_name }}
          destination_branch: 'master'
          github_token: ${{ secrets.PAT }}
          pr_title: 'chore(release): pulling ${{ steps.create-release.outputs.branch_name }} into master'
          pr_body: ':crown: *An automated PR*'
